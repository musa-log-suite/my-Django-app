<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reset Your Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .high-contrast {
            background-color: #000 !important;
            color: #fff !important;
        }
        .high-contrast input {
            background-color: #222 !important;
            color: #fff !important;
            border-color: #fff !important;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-sm" role="form" aria-labelledby="resetHeader">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <h4 id="resetHeader" class="mb-0">Reset Your Password</h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-light" id="darkToggle" title="Toggle Dark Mode">üåô</button>
                            <button class="btn btn-sm btn-light" id="contrastToggle" title="High Contrast">üåì</button>
                            <button class="btn btn-sm btn-light" id="langToggle" title="Switch Language">üåê</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form method="post" novalidate>
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="otp" class="form-label">Enter OTP</label>
                                <input type="text" name="otp" id="otp" class="form-control" autocomplete="one-time-code" required aria-required="true">
                                <div id="otp-timer" class="form-text text-danger mt-2"></div>
                            </div>

                            <div class="mb-3 position-relative">
                                <label for="new_password" class="form-label">New Password</label>
                                <input type="password" name="new_password" id="new_password" class="form-control" autocomplete="new-password" required aria-required="true">
                                <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2" id="togglePassword">
                                    Show
                                </button>
                                <div id="password-strength" class="form-text text-muted mt-1"></div>
                            </div>

                            <div class="mb-3">
                                <label for="confirm_password" class="form-label">Confirm Password</label>
                                <input type="password" name="confirm_password" id="confirm_password" class="form-control" autocomplete="new-password" required aria-required="true">
                                <div id="match-warning" class="form-text text-danger mt-1 d-none">Passwords do not match.</div>
                            </div>

                            <button type="submit" class="btn btn-danger w-100" id="submitBtn">Reset Password</button>
                        </form>

                        <div class="text-center mt-4">
                            <p class="mb-2">Didn't receive the OTP?</p>
                            <a href="#" id="resendBtn" class="btn btn-outline-secondary btn-sm disabled">Resend OTP</a>
                        </div>
                    </div>
                </div>
                <p class="text-center mt-3 text-muted" id="otpNote">
                    Use the OTP sent to your phone or email to reset your password.
                </p>
            </div>
        </div>
    </div>

    <!-- ‚úÖ Toast Container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
        <div id="toastContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/imask"></script>

    {% if messages %}
    <script>
        window.addEventListener("load", () => {
            const toastContainer = document.getElementById("toastContainer");
            {% for message in messages %}
                const toast = document.createElement("div");
                toast.className = "toast align-items-center text-white bg-{{ message.tags }} border-0 mb-2";
                toast.setAttribute("role", "alert");
                toast.setAttribute("aria-live", "assertive");
                toast.setAttribute("aria-atomic", "true");
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">{{ message }}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                toastContainer.appendChild(toast);
                new bootstrap.Toast(toast).show();
            {% endfor %}
        });
    </script>
    {% endif %}

    <script>
        // ‚úÖ Input Masking for OTP
        IMask(document.getElementById("otp"), {
            mask: '000000'
        });

        // ‚úÖ Auto-focus on OTP
        window.addEventListener("load", () => {
            document.getElementById("otp").focus();
            startOTPTimer();
        });

        // ‚úÖ Password Strength Meter
        const passwordInput = document.getElementById("new_password");
        const strengthText = document.getElementById("password-strength");

        passwordInput.addEventListener("input", function () {
            const value = passwordInput.value;
            let strength = "Weak";

            if (value.length >= 8 && /[A-Z]/.test(value) && /[0-9]/.test(value) && /[^A-Za-z0-9]/.test(value)) {
                strength = "Strong";
                strengthText.className = "form-text text-success mt-1";
            } else if (value.length >= 6) {
                strength = "Medium";
                strengthText.className = "form-text text-warning mt-1";
            } else {
                strength = "Weak";
                strengthText.className = "form-text text-muted mt-1";
            }

            strengthText.textContent = `Password Strength: ${strength}`;
        });

        // ‚úÖ Show/Hide Password Toggle
        const toggleBtn = document.getElementById("togglePassword");
        toggleBtn.addEventListener("click", function () {
            const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
            passwordInput.setAttribute("type", type);
            this.textContent = type === "password" ? "Show" : "Hide";
        });

        // ‚úÖ Confirm Password Match Check
        const confirmInput = document.getElementById("confirm_password");
        const matchWarning = document.getElementById("match-warning");
        const submitBtn = document.getElementById("submitBtn");

        confirmInput.addEventListener("input", () => {
            if (confirmInput.value !== passwordInput.value) {
                matchWarning.classList.remove("d-none");
                submitBtn.disabled = true;
            } else {
                matchWarning.classList.add("d-none");
                submitBtn.disabled = false;
            }
        });

        // ‚úÖ OTP Expiration Countdown
        function startOTPTimer(duration = 120) {
            const timerDisplay = document.getElementById("otp-timer");
            let timeLeft = duration;

            const interval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `OTP expires in ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    timerDisplay.textContent = "OTP has expired. Please request a new one.";
                }

                timeLeft--;
            }, 1000);
        }

        // ‚úÖ Resend OTP Cooldown
        const resendBtn = document.getElementById("resendBtn");

        function enableResendAfter(seconds = 120) {
            setTimeout(() => {
                resendBtn.classList.remove("disabled");
                resendBtn.setAttribute("href", "{% url 'users:template-resend-password-otp' %}");
                resendBtn.textContent = "Resend OTP";
            }, seconds * 1000);
        }

        enableResendAfter();

        // ‚úÖ Dark Mode Toggle
        const darkToggle = document.getElementById("darkToggle");
        darkToggle.addEventListener("click", () => {
            document.body.classList.toggle("bg-dark");
            document.body.classList.toggle("text-white");
        });

        // ‚úÖ High Contrast Toggle
        const contrastToggle = document.getElementById("contrastToggle");
        contrastToggle.addEventListener("click", () => {
            document.body.classList.toggle("high-contrast");
        });